environment: "stage"

#localPlatforms:
#  - "linux/amd64"
#  - "linux/x86_64"
#  - "local"
#  - "localhost"

instanceTag: "rhtap-staging"

additionalInstanceTags:
  service-phase: "Staging"

archDefaults:
  arm64:
    ami: "ami-06f37afe6d4f43c47"
    key-name: "konflux-stage-int-mab01"
    security-group-id: "sg-0482e8ccae008b240"
    subnet-id: "subnet-07597d1edafa2b9d3"
  amd64:
    ami: "ami-01aaf1c29c7e0f0af"
    key-name: "konflux-stage-int-mab01"
    security-group-id: "sg-0482e8ccae008b240"
    subnet-id: "subnet-07597d1edafa2b9d3"


dynamicConfigs:
  linux-arm64:
    subnet-id: "subnet-01b88957a67590dc2"

  linux-amd64:
    subnet-id: "subnet-06132f7bf72af6ce6"

  linux-mlarge-arm64: {}

  linux-mlarge-amd64: {}

  linux-mxlarge-arm64: {}

  linux-mxlarge-amd64: {}

  linux-m2xlarge-arm64: {}

  linux-m2xlarge-amd64: {}

  linux-m4xlarge-arm64: {}

  linux-m4xlarge-amd64: {}

  linux-m8xlarge-arm64: {}

  linux-m8xlarge-amd64: {}

  linux-c6gd2xlarge-arm64:
    user-data: |
      Content-Type: multipart/mixed; boundary="//"
      MIME-Version: 1.0

      --//
      Content-Type: text/cloud-config; charset="us-ascii"
      MIME-Version: 1.0
      Content-Transfer-Encoding: 7bit
      Content-Disposition: attachment; filename="cloud-config.txt"

      #cloud-config
      cloud_final_modules:
        - [scripts-user, always]

      --//
      Content-Type: text/x-shellscript; charset="us-ascii"
      MIME-Version: 1.0
      Content-Transfer-Encoding: 7bit
      Content-Disposition: attachment; filename="userdata.txt"

      #!/bin/bash -ex

      # Format and mount NVMe disk
      mkfs -t xfs /dev/nvme1n1
      mount /dev/nvme1n1 /home

      # Create required directories
      mkdir -p /home/var-lib-containers /var/lib/containers /home/var-tmp /var/tmp /home/ec2-user/.ssh

      # Setup bind mounts
      mount --bind /home/var-lib-containers /var/lib/containers
      mount --bind /home/var-tmp /var/tmp
      restorecon -r /var/lib/containers /var/tmp

      # Configure ec2-user SSH access
      chown -R ec2-user /home/ec2-user
      sed -n 's,.*\(ssh-.*\s\),\1,p' /root/.ssh/authorized_keys > /home/ec2-user/.ssh/authorized_keys
      chown ec2-user /home/ec2-user/.ssh/authorized_keys
      chmod 600 /home/ec2-user/.ssh/authorized_keys
      chmod 700 /home/ec2-user/.ssh
      restorecon -r /home/ec2-user

      --//--

  linux-cxlarge-arm64: {}

  linux-cxlarge-amd64: {}

  linux-c2xlarge-arm64: {}

  linux-c2xlarge-amd64: {}

  linux-c4xlarge-arm64: {}

  linux-c4xlarge-amd64: {}

  linux-c8xlarge-arm64: {}

  linux-c8xlarge-amd64: {}

  linux-g4xlarge-amd64: {}

  linux-g64xlarge-amd64:
    ami: "ami-0133ba5e6e6d57a02"
    user-data: |
      Content-Type: multipart/mixed; boundary="//"
      MIME-Version: 1.0

      --//
      Content-Type: text/cloud-config; charset="us-ascii"
      MIME-Version: 1.0
      Content-Transfer-Encoding: 7bit
      Content-Disposition: attachment; filename="cloud-config.txt"

      #cloud-config
      cloud_final_modules:
        - [scripts-user, always]

      --//
      Content-Type: text/x-shellscript; charset="us-ascii"
      MIME-Version: 1.0
      Content-Transfer-Encoding: 7bit
      Content-Disposition: attachment; filename="userdata.txt"

      #!/bin/bash -ex

      # Format and mount NVMe disk
      mkfs -t xfs /dev/nvme1n1
      mount /dev/nvme1n1 /home

      # Create required directories
      mkdir -p /home/var-lib-containers /var/lib/containers /home/var-tmp /var/tmp /home/ec2-user/.ssh

      # Setup bind mounts
      mount --bind /home/var-lib-containers /var/lib/containers
      mount --bind /home/var-tmp /var/tmp
      chmod a+rw /var/tmp
      restorecon -r /var/lib/containers /var/tmp

      # Configure ec2-user SSH access
      chown -R ec2-user /home/ec2-user
      sed -n 's,.*\(ssh-.*\s\),\1,p' /root/.ssh/authorized_keys > /home/ec2-user/.ssh/authorized_keys
      chown ec2-user /home/ec2-user/.ssh/authorized_keys
      chmod 600 /home/ec2-user/.ssh/authorized_keys
      chmod 700 /home/ec2-user/.ssh
      restorecon -r /home/ec2-user

      # GPU setup
      mkdir -p /etc/cdi /var/run/cdi
      chmod a+rwx /etc/cdi /var/run/cdi
      setsebool container_use_devices 1 2>/dev/null || true
      su - ec2-user
      nvidia-ctk cdi generate --output=/etc/cdi/nvidia.yaml
      chmod a+rw /etc/cdi/nvidia.yaml
      --//--

  macos-mac2metal-arm64:
    ami: "ami-000ce2c23b96216d3"
    host-resource-group-arn: "arn:aws:resource-groups:us-east-1:654654171619:group/MacOS-Servers"
    license-configuration-arn: "arn:aws:license-manager:us-east-1:654654171619:license-configuration:lic-fecd71a2010a12080e452eb28065f489"
    user-data: |
      #!/bin/bash
      set -eu
      set -x

      user="konflux-builder"

      # Check if user already exists
      if ! id "$user" &>/dev/null; then
          # Generate random password
          random_password=$(openssl rand -base64 32)

          # Create user
          sudo sysadminctl -addUser "$user" -fullName "Konflux Builder" -password "$random_password" -home /Users/$user

          # Clear password from variable
          unset random_password
      else
          echo "User $user already exists, skipping user creation"
      fi

      # Create home directory if it doesn't exist
      sudo mkdir -p /Users/$user

      # Create SSH directory
      sudo mkdir -p /Users/$user/.ssh

      # Remove existing SSH keys if they exist
      sudo rm -f /Users/$user/.ssh/id_rsa /Users/$user/.ssh/id_rsa.pub

      # Generate new SSH keys
      sudo ssh-keygen -t rsa -b 4096 -f /Users/$user/.ssh/id_rsa -N "" -C ""

      # Set proper permissions on .ssh directory
      sudo chmod 700 /Users/$user/.ssh

      # Create/overwrite authorized_keys
      sudo chmod 600 /Users/$user/.ssh/authorized_keys 2>/dev/null || true
      sudo cat /Users/$user/.ssh/id_rsa.pub | sudo tee /Users/$user/.ssh/authorized_keys > /dev/null

      # Set ownership of entire home directory to ensure user has full control
      sudo chown -R $user:staff /Users/$user

      # Copy private key to ec2-user's directory
      sudo cp /Users/$user/.ssh/id_rsa /Users/ec2-user/$user

      # Set ownership of the copied private key to ec2-user
      sudo chown ec2-user:staff /Users/ec2-user/$user
      sudo chmod 600 /Users/ec2-user/$user

      --//--

  linux-root-arm64:
    sudo-commands: "/usr/bin/podman"
    disk: "200"

  linux-root-amd64:
    sudo-commands: "/usr/bin/podman"
    disk: "200"

# Static hosts configuration
staticHosts:
  ppc64le-static-1:
    address: "10.130.103.155"
    concurrency: "2"
    platform: "linux/ppc64le"
    secret: "ibm-ppc64le-ssh-key"
    user: "root"

  s390x-static-1:
    address: "10.130.103.103"
    concurrency: "2"
    platform: "linux/s390x"
    secret: "ibm-s390x-ssh-key"
    user: "root"
