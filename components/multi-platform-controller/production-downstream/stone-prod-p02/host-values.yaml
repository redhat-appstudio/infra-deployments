environment: "prod"

archDefaults:
  arm64:
    ami: "ami-06f37afe6d4f43c47"
    key-name: "konflux-prod-int-mab01"
    security-group-id: "sg-0903aedd465be979e"
    subnet-id: "subnet-02c476f8d2a4ae05e"
  amd64:
    ami: "ami-01aaf1c29c7e0f0af"
    key-name: "konflux-prod-int-mab01"
    security-group-id: "sg-0903aedd465be979e"
    subnet-id: "subnet-02c476f8d2a4ae05e"
  windows-amd64:
    ami: "ami-0cf643428c5013531"
    key-name: "aws-win-ssh-key"
    security-group-id: "sg-0903aedd465be979e"
    subnet-id: "subnet-02c476f8d2a4ae05e"
    ssh-secret: "aws-win-ssh-key"
  macos-mac2metal-arm64:
    ami: "ami-000ce2c23b96216d3"
    host-resource-group-arn: "arn:aws:resource-groups:us-east-1:381491906438:group/macos-servers"
    license-configuration-arn: "arn:aws:license-manager:us-east-1:381491906438:license-configuration:lic-becd775af7ca09c097f1fa94e495e148"
    key-name: "konflux-prod-int-mab01"
    security-group-id: "sg-0903aedd465be979e"
    subnet-id: "subnet-02c476f8d2a4ae05e"

dynamicConfigs:
  linux-arm64: {}

  linux-amd64: {}

  linux-mlarge-arm64: {}

  linux-mlarge-amd64: {}

  linux-mxlarge-arm64: {}

  linux-mxlarge-amd64: {}

  linux-m2xlarge-arm64: {}

  linux-m2xlarge-amd64: {}

  linux-d160-m2xlarge-arm64: {}

  linux-d160-m2xlarge-amd64: {}

  linux-m4xlarge-arm64: {}

  linux-m4xlarge-amd64: {}

  linux-d160-m4xlarge-arm64: {}

  linux-d160-m4xlarge-amd64: {}

  linux-m8xlarge-arm64: {}

  linux-m8xlarge-amd64: {}

  linux-d160-m8xlarge-arm64: {}

  linux-d160-m8xlarge-amd64: {}

  linux-d160-c4xlarge-amd64: {}

  linux-d160-c4xlarge-arm64: {}

  linux-d320-c4xlarge-amd64: {}

  linux-d320-c4xlarge-arm64: {}

  linux-d320-m8xlarge-amd64: {}

  linux-d320-m8xlarge-arm64: {}

  linux-fast-amd64: {}

  linux-extra-fast-amd64: {}

  linux-c6gd2xlarge-arm64:
    user-data: |
      Content-Type: multipart/mixed; boundary="//"
      MIME-Version: 1.0

      --//
      Content-Type: text/cloud-config; charset="us-ascii"
      MIME-Version: 1.0
      Content-Transfer-Encoding: 7bit
      Content-Disposition: attachment; filename="cloud-config.txt"

      #cloud-config
      cloud_final_modules:
        - [scripts-user, always]

      --//
      Content-Type: text/x-shellscript; charset="us-ascii"
      MIME-Version: 1.0
      Content-Transfer-Encoding: 7bit
      Content-Disposition: attachment; filename="userdata.txt"

      #!/bin/bash -ex

      # Format and mount NVMe disk
      mkfs -t xfs /dev/nvme1n1
      mount /dev/nvme1n1 /home

      # Create required directories
      mkdir -p /home/var-lib-containers /var/lib/containers /home/var-tmp /var/tmp /home/ec2-user/.ssh

      # Setup bind mounts
      mount --bind /home/var-lib-containers /var/lib/containers
      mount --bind /home/var-tmp /var/tmp
      restorecon -r /var/lib/containers /var/tmp

      # Configure ec2-user SSH access
      chown -R ec2-user /home/ec2-user
      sed -n 's,.*\(ssh-.*\s\),\1,p' /root/.ssh/authorized_keys > /home/ec2-user/.ssh/authorized_keys
      chown ec2-user /home/ec2-user/.ssh/authorized_keys
      chmod 600 /home/ec2-user/.ssh/authorized_keys
      chmod 700 /home/ec2-user/.ssh
      restorecon -r /home/ec2-user

      --//--

  linux-cxlarge-arm64: {}

  linux-cxlarge-amd64: {}

  linux-c2xlarge-arm64: {}

  linux-c2xlarge-amd64: {}

  linux-c4xlarge-arm64: {}

  linux-c4xlarge-amd64: {}

  linux-c8xlarge-arm64: {}

  linux-c8xlarge-amd64: {}

  linux-g4xlarge-amd64: {}

  linux-g64xlarge-amd64:
    ami: "ami-0133ba5e6e6d57a02"
    user-data: |
      Content-Type: multipart/mixed; boundary="//"
      MIME-Version: 1.0

      --//
      Content-Type: text/cloud-config; charset="us-ascii"
      MIME-Version: 1.0
      Content-Transfer-Encoding: 7bit
      Content-Disposition: attachment; filename="cloud-config.txt"

      #cloud-config
      cloud_final_modules:
        - [scripts-user, always]

      --//
      Content-Type: text/x-shellscript; charset="us-ascii"
      MIME-Version: 1.0
      Content-Transfer-Encoding: 7bit
      Content-Disposition: attachment; filename="userdata.txt"

      #!/bin/bash -ex

      # Format and mount NVMe disk
      mkfs -t xfs /dev/nvme1n1
      mount /dev/nvme1n1 /home

      # Create required directories
      mkdir -p /home/var-lib-containers /var/lib/containers /home/var-tmp /var/tmp /home/ec2-user/.ssh

      # Setup bind mounts
      mount --bind /home/var-lib-containers /var/lib/containers
      mount --bind /home/var-tmp /var/tmp
      chmod a+rw /var/tmp
      restorecon -r /var/lib/containers /var/tmp

      # Configure ec2-user SSH access
      chown -R ec2-user /home/ec2-user
      sed -n 's,.*\(ssh-.*\s\),\1,p' /root/.ssh/authorized_keys > /home/ec2-user/.ssh/authorized_keys
      chown ec2-user /home/ec2-user/.ssh/authorized_keys
      chmod 600 /home/ec2-user/.ssh/authorized_keys
      chmod 700 /home/ec2-user/.ssh
      restorecon -r /home/ec2-user

      # GPU setup
      mkdir -p /etc/cdi /var/run/cdi
      chmod a+rwx /etc/cdi /var/run/cdi
      setsebool container_use_devices 1 2>/dev/null || true
      su - ec2-user
      nvidia-ctk cdi generate --output=/etc/cdi/nvidia.yaml
      chmod a+rw /etc/cdi/nvidia.yaml
      --//--

  linux-root-arm64:
    iops: "16000"
    throughput: "1000"
    sudo-commands: "/usr/bin/podman, /usr/bin/rm /usr/share/containers/mounts.conf"
    disk: "200"

  macos-mac2metal-arm64:
    ami: "ami-000ce2c23b96216d3"
    host-resource-group-arn: "arn:aws:resource-groups:us-east-1:381491906438:group/macos-servers"
    license-configuration-arn: "arn:aws:license-manager:us-east-1:381491906438:license-configuration:lic-becd775af7ca09c097f1fa94e495e148"
    user-data: |
      #!/bin/bash
      set -eu
      set -x

      user="konflux-builder"

      # Check if user already exists
      if ! id "$user" &>/dev/null; then
        # Generate random password
        random_password=$(openssl rand -base64 32)

        # Create user
        sudo sysadminctl -addUser "$user" -fullName "Konflux Builder" -password "$random_password" -home /Users/$user

        # Clear password from variable
        unset random_password
      else
        echo "User $user already exists, skipping user creation"
      fi

      # Create home directory if it doesn't exist
      sudo mkdir -p /Users/$user

      # Create SSH directory
      sudo mkdir -p /Users/$user/.ssh

      # Remove existing SSH keys if they exist
      sudo rm -f /Users/$user/.ssh/id_rsa /Users/$user/.ssh/id_rsa.pub

      # Generate new SSH keys
      sudo ssh-keygen -t rsa -b 4096 -f /Users/$user/.ssh/id_rsa -N "" -C ""

      # Set proper permissions on .ssh directory
      sudo chmod 700 /Users/$user/.ssh

      # Create/overwrite authorized_keys
      sudo chmod 600 /Users/$user/.ssh/authorized_keys 2>/dev/null || true
      sudo cat /Users/$user/.ssh/id_rsa.pub | sudo tee /Users/$user/.ssh/authorized_keys > /dev/null
      sudo cat /Users/$user/.ssh/id_rsa | sudo tee /Users/ec2-user/$user > /dev/null

      # Set ownership of entire home directory to ensure user has full control
      sudo chown -R $user:staff /Users/$user

      # Set ownership of the copied private key to ec2-user
      sudo chown ec2-user:staff /Users/ec2-user/$user
      sudo chmod 600 /Users/ec2-user/$user

  windows-4xlarge-amd64:
    user-data: |
      <powershell>
      ## -----------------------------------------
      ## --------- Helper Functions --------------
      ## -----------------------------------------
      function Wait-Folder {
        param(
          [Parameter(Mandatory=$true)]
          [string]$FolderPath,
          [Parameter(Mandatory=$false)]
          [int]$TimeoutSeconds = 30
        )

        Write-Host "Waiting for folder '${FolderPath}' to be created"

        # Start a timer
        $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()

        while (-not (Test-Path -Path ${FolderPath})) {
          # Check if we have exceeded the timeout
          if ($stopwatch.Elapsed.TotalSeconds -ge $TimeoutSeconds) {
            Write-Error "Timeout reached! Folder was not created within $TimeoutSeconds seconds."
            $stopwatch.Stop()
            return $false
          }

          Write-Host "Waiting for folder..." -NoNewline
          Start-Sleep -Seconds 1
        }

        $stopwatch.Stop()
        return $true
      }

      ## -----------------------------------------
      ## --------- Create Local User -------------
      ## -----------------------------------------
      $user = "konflux-builder"

      if ((Get-LocalUser -Name "${user}" -ErrorAction SilentlyContinue) -eq $null) {
        # Generate random password
        $password = (-join([char[]](33..122) | Get-Random -Count 30))
        $securePassword = (ConvertTo-SecureString $password -AsPlainText -Force)

        # Create user
        New-LocalUser -Name $user -Password $securePassword -Description "Konflux Builder" | Out-Null
        Add-LocalGroupMember -Group 'Users' -Member "${user}"
        Add-LocalGroupMember -Group 'OpenSSH Users' -Member "${user}"

        # Create a Credential Object for the new user
        $userCred = New-Object System.Management.Automation.PSCredential($user, $securePassword)

        # Start a dummy Process as the new User
        # This is required to have the user home folder initialized.
        # TODO: can we do better?
        Start-Process -FilePath "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" `
          -Credential ${userCred} `
          -ArgumentList "-Command exit" `
          -LoadUserProfile `
          -WindowStyle Hidden `
          -WorkingDirectory "C:\Users\" `
          -Wait

        # Create SSH Key for user
        Write-Host "Creating SSH Key for user '${user}'"
        $tempKey = "${env:TEMP}\${user}"

        if (Test-Path "${tempKey}") { Remove-Item -Force "${tempKey}" }
        if (Test-Path "${tempKey}.pub") { Remove-Item -Force "${tempKey}.pub" }

        ssh-keygen -t rsa -f "${tempKey}" -N `"`" | Out-Null

        # Move private key to a secure location and restrict access to it
        $privateKeyPath = "C:\Users\Administrator\${user}"
        mv "${env:TEMP}\${user}" "${privateKeyPath}"

        $ACL = Get-Acl "${privateKeyPath}"
        $Ar = New-Object System.Security.AccessControl.FileSystemAccessRule("NT AUTHORITY\SYSTEM", "FullControl", "Allow")
        $ACL.SetAccessRule($Ar)
        $Ar = New-Object System.Security.AccessControl.FileSystemAccessRule("BUILTIN\Administrators", "FullControl", "Allow")
        $ACL.SetAccessRule($Ar)
        Set-Acl "${privateKeyPath}" ${ACL}

        # Initialize user home folder
        $userHome = "C:\Users\${user}"
        Write-Host "Waiting for User Home '${userHome}' to be created"

        # Ensure User's home folder is eventually created
        if (-not (Wait-Folder -FolderPath ${userHome})) {
          Write-Error "Folder '${userHome}' not found! Cleanup..." -ForegroundColor Red
          if (Test-Path "\${tempKey}") { Remove-Item -Force "${tempKey}" }
          if (Test-Path "\${tempKey}.pub") { Remove-Item -Force "${tempKey}.pub" }
          exit 1
        }

        # Set up SSH Keys for User
        Write-Host "User Home found. Configuring SSH access" -ForegroundColor Green
        New-Item -ItemType Directory -Force -Path "${userHome}\.ssh"
        New-Item -ItemType Directory -Force -Path "${userHome}\build"

        # Copying and removing to preserve file permissions! Do not use `mv`! :)
        cp "${tempKey}.pub" "${userHome}\.ssh\authorized_keys"
        rm "${tempKey}.pub"
      }

      ## -------------------------------------------------
      ## --------- Enable Windows Containers -------------
      ## -------------------------------------------------
      Invoke-WebRequest -UseBasicParsing "https://raw.githubusercontent.com/microsoft/Windows-Containers/Main/helpful_tools/Install-DockerCE/install-docker-ce.ps1" -o install-docker-ce.ps1
      .\install-docker-ce.ps1 -NoRestart

      if (${global:RebootRequired}) {
        Restart-Computer
        exit
      }

      # Create docker-users group and add konflux-builder to it
      if ((Get-LocalGroup -Name 'docker-users') -eq $null) {
        New-LocalGroup -Name 'docker-users' -Description 'Docker Users'
      }

      if ((Get-LocalGroupMember -Group 'docker-users' -Member 'konflux-builder') -eq $null) {
        Add-LocalGroupMember -Group 'docker-users' -Member "${user}"
      }

      # Allow the docker-users group to use docker
      $dockerConfigPath = "C:\ProgramData\docker\config\daemon.json"
      $existingConfig = Get-Content $dockerConfigPath -Raw | ConvertFrom-Json

      if ((${existingConfig}.group) -eq $null) {
        $existingConfig | Add-Member -NotePropertyName "group" -NotePropertyValue "docker-users" -Force
        $existingConfig | ConvertTo-Json -Depth 10 | Set-Content $dockerConfigPath
        Restart-Service docker
      }

      # Exclude docker in Windows Defender
      Add-MpPreference -ExclusionProcess "dockerd.exe"
      Add-MpPreference -ExclusionProcess "docker.exe"
      Add-MpPreference -ExclusionProcess "containerd.exe"
      Add-MpPreference -ExclusionProcess "vmcompute.exe"

      ## -----------------------------------------
      ## --------- Configure OpenSSH -------------
      ## -----------------------------------------
      # Install OpenSSH Server
      Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0

      # Start the sshd service and set it to start automatically
      Start-Service sshd
      Set-Service -Name sshd -StartupType 'Automatic'

      # Grab the Public Key from AWS Metadata and configure authorized_keys
      # This allows you to log in with your .pem/.ppk file instead of a password
      $MAGIC_IP = "169.254.169.254"
      $IMDS_TOKEN = Invoke-RestMethod -Uri "http://${MAGIC_IP}/latest/api/token" -Method 'PUT' -Headers @{'X-aws-ec2-metadata-token-ttl-seconds' = '21600'}
      $PUBKEY = Invoke-RestMethod -Uri "http://${MAGIC_IP}/latest/meta-data/public-keys/0/openssh-key" -Headers @{'X-aws-ec2-metadata-token' = $IMDS_TOKEN}

      # Ensure SSH_PATH folder was created
      $SSH_PATH = "C:\ProgramData\ssh"
      Write-Host "Waiting for SSH Folder"

      if (-not (Wait-Folder -FolderPath ${SSH_PATH})) {
        Write-Error "Folder '${SSH_PATH}' not found! Exiting..." -ForegroundColor Red
        exit 1
      }

      Write-Host "Folder '${SSH_PATH}' found"

      # Add key to administrators_authorized_keys
      $PUBKEY | Out-File -FilePath "$SSH_PATH\administrators_authorized_keys" -Encoding ascii

      # Fix permissions (ACLs) for the authorized_keys file
      # OpenSSH is strict: only System and Administrators should have access
      $ACL = Get-Acl "$SSH_PATH\administrators_authorized_keys"
      $Ar = New-Object System.Security.AccessControl.FileSystemAccessRule("NT AUTHORITY\SYSTEM", "FullControl", "Allow")
      $ACL.SetAccessRule($Ar)
      $Ar = New-Object System.Security.AccessControl.FileSystemAccessRule("BUILTIN\Administrators", "FullControl", "Allow")
      $ACL.SetAccessRule($Ar)
      Set-Acl "$SSH_PATH\administrators_authorized_keys" $ACL

      # Restart sshd to apply key changes
      Restart-Service sshd

      # Configure the Firewall to allow SSH (Port 22)
      Remove-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' | Out-Null
      New-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22 -RemoteAddress any
      Write-Output "Firewall Rule 'OpenSSH-Server-In-TCP' updated"
      </powershell>
      <persist>true</persist>

  linux-root-amd64:
    iops: "16000"
    throughput: "1000"
    sudo-commands: "/usr/bin/podman, /usr/bin/rm /usr/share/containers/mounts.conf"
    disk: "200"
    instance-type: "m5.4xlarge"

# Static hosts configuration
staticHosts:
  #PPC
  ppc64le-pi-static-x0:
    address: 10.130.76.49
    concurrency: '8'
    platform: linux/ppc64le
    secret: ibm-ppc64le-ssh-key
    user: root

  ppc64le-pi-static-x1:
    address: 10.130.76.38
    concurrency: '8'
    platform: linux/ppc64le
    secret: ibm-ppc64le-ssh-key
    user: root

  ppc64le-pi-static-x2:
    address: 10.130.76.39
    concurrency: '8'
    platform: linux/ppc64le
    secret: ibm-ppc64le-ssh-key
    user: root

  ppc64le-pi-static-x3:
    address: 10.130.76.50
    concurrency: '8'
    platform: linux/ppc64le
    secret: ibm-ppc64le-ssh-key
    user: root

  ppc64le-pi-static-x4:
    address: 10.130.76.51
    concurrency: '8'
    platform: linux/ppc64le
    secret: ibm-ppc64le-ssh-key
    user: root

  ppc64le-pi-static-x5:
    address: 10.130.76.35
    concurrency: '8'
    platform: linux/ppc64le
    secret: ibm-ppc64le-ssh-key
    user: root

  ppc64le-pi-static-x6:
    address: 10.130.76.42
    concurrency: '8'
    platform: linux/ppc64le
    secret: ibm-ppc64le-ssh-key
    user: root

  ppc64le-pi-static-x7:
    address: 10.130.76.40
    concurrency: '8'
    platform: linux/ppc64le
    secret: ibm-ppc64le-ssh-key
    user: root

  s390x-static-x0:
    address: 10.130.103.4
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x1:
    address: 10.130.103.36
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x2:
    address: 10.130.103.68
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x3:
    address: 10.130.103.5
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x4:
    address: 10.130.103.37
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x5:
    address: 10.130.103.69
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x6:
    address: 10.130.103.6
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x7:
    address: 10.130.103.38
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x8:
    address: 10.130.103.70
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x9:
    address: 10.130.103.7
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x10:
    address: 10.130.103.39
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x11:
    address: 10.130.103.71
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x12:
    address: 10.130.103.8
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x13:
    address: 10.130.103.40
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x14:
    address: 10.130.103.72
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x15:
    address: 10.130.103.9
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x16:
    address: 10.130.103.41
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root

  s390x-static-x17:
    address: 10.130.103.73
    concurrency: '4'
    platform: linux/s390x
    secret: ibm-s390x-ssh-key
    user: root
