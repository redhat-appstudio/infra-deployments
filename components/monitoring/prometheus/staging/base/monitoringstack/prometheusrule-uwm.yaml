---
- op: replace
  path: /spec/groups
  value:
    - name: rules_container_namespace
      rules:
      - expr: |
          avg by (namespace,container) (rate(container_memory_working_set_bytes{job="kubelet", metrics_path="/metrics/cadvisor", image!=""}[5m]))
        record: namespace_container:container_memory_working_set_bytes
      - expr: |
          avg by (namespace,container) (rate(container_cpu_usage_seconds_total{job="kubelet", metrics_path="/metrics/cadvisor", image!=""}[5m]))
        record: namespace_container:container_cpu_usage_seconds_total
    - name: rules_kubearchive
      rules:
      - record: kubearchive:api:latency
        expr: |
          sum by (http_status_code, http_route)(rate(http_server_request_duration_sum{exported_job="kubearchive.api"}[5m])) / sum by (http_status_code, http_route)(rate(http_server_request_duration_count{exported_job="kubearchive.api"}[5m]))
      - record: kubearchive:sink:latency
        expr: |
          sum by (http_status_code, http_route)(rate(http_server_request_duration_sum{exported_job="kubearchive.sink"}[5m])) / sum by (http_status_code, http_route)(rate(http_server_request_duration_count{exported_job="kubearchive.sink"}[5m]))
      - record: kubearchive:api:db_latency
        expr: |
          sum by (method) (rate(db_sql_latency_sum{exported_job="kubearchive.api"}[5m])) / sum by (method) (rate(db_sql_latency_count{exported_job="kubearchive.api"}[5m]))
      - record: kubearchive:sink:db_latency
        expr: |
          sum by (method) (rate(db_sql_latency_sum{exported_job="kubearchive.sink"}[5m])) / sum by (method) (rate(db_sql_latency_count{exported_job="kubearchive.sink"}[5m]))

