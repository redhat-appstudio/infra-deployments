---
- op: replace
  path: /spec/groups
  value:
    - name: rules_container_namespace
      rules:
      - expr: |
          avg by (namespace,container) (rate(container_memory_working_set_bytes{job="kubelet", metrics_path="/metrics/cadvisor", image!=""}[5m]))
        record: namespace_container:container_memory_working_set_bytes
      - expr: |
          avg by (namespace,container) (rate(container_cpu_usage_seconds_total{job="kubelet", metrics_path="/metrics/cadvisor", image!=""}[5m]))
        record: namespace_container:container_cpu_usage_seconds_total
      # worker node metrics
      - expr: |
          sum(node_namespace_pod_container:container_memory_working_set_bytes{cluster="", container!="",namespace=~".*tenant"}) by (node) and on (node) kube_node_role{role="worker"}
        record: worker_node:container_memory_working_set_bytes_tenant:sum
      - expr: |
          sum(node_namespace_pod_container:container_memory_working_set_bytes{cluster="", container!="",namespace!~".*tenant"}) by (node) and on (node) kube_node_role{role="worker"}
        record: worker_node:container_memory_working_set_bytes_non_tenant:sum
      - expr: |
          sum(kube_node_status_capacity{cluster="", resource="memory"}) by (node)  and on (node) kube_node_role{role="worker"}
        record: worker_node:kube_node_status_capacity_memory:sum
      - expr: |
          sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{cluster="",namespace=~".*-tenant"}) by (node) and on (node) kube_node_role{role="worker"}
        record: worker_node:container_cpu_usage_seconds_total_tenant:sum
      - expr: |
          sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{cluster="",namespace!~".*-tenant"}) by (node) and on (node) kube_node_role{role="worker"}
        record: worker_node:container_cpu_usage_seconds_total_non_tenant:sum
      - expr: |
          sum(kube_node_status_capacity{cluster="", resource="cpu"}) by (node) and on (node) kube_node_role{role="worker"}
        record: worker_node:kube_node_status_capacity_cpu:sum
      # infra node metrics
      - expr: |
          sum(node_namespace_pod_container:container_memory_working_set_bytes{cluster="", container!="",namespace!~".*tenant"}) by (node) and on (node) kube_node_role{role="infra"}
        record: infra_node:container_memory_working_set_bytes_non_tenant:sum
      - expr: |
          sum(kube_node_status_capacity{cluster="", resource="memory"}) by (node)  and on (node) kube_node_role{role="infra"}
        record: infra_node:kube_node_status_capacity_memory:sum
      - expr: |
          sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{cluster="",namespace!~".*-tenant"}) by (node) and on (node) kube_node_role{role="infra"}
        record: infra_node:container_cpu_usage_seconds_total_non_tenant:sum
      - expr: |
          sum(kube_node_status_capacity{cluster="", resource="cpu"}) by (node) and on (node) kube_node_role{role="infra"}
        record: infra_node:kube_node_status_capacity_cpu:sum
      # master node metrics
      - expr: |
          sum(node_namespace_pod_container:container_memory_working_set_bytes{cluster="", container!="",namespace!~".*tenant"}) by (node) and on (node) kube_node_role{role="master"}
        record: master_node:container_memory_working_set_bytes_non_tenant:sum
      - expr: |
          sum(kube_node_status_capacity{cluster="", resource="memory"}) by (node)  and on (node) kube_node_role{role="master"}
        record: master_node:kube_node_status_capacity_memory:sum
      - expr: |
          sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{cluster="",namespace!~".*-tenant"}) by (node) and on (node) kube_node_role{role="master"}
        record: master_node:container_cpu_usage_seconds_total_non_tenant:sum
      - expr: |
          sum(kube_node_status_capacity{cluster="", resource="cpu"}) by (node) and on (node) kube_node_role{role="master"}
        record: master_node:kube_node_status_capacity_cpu:sum
