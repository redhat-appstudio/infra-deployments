---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: oauth-secret-generator
  namespace: image-rbac-proxy
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: oauth-secret-generator
  namespace: image-rbac-proxy
rules:
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - list
  - create
  - get
  - update
  - patch
  - delete
- apiGroups:
  - apps
  resources:
  - deployments
  verbs:
  - get
  - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: oauth-secret-generator
  namespace: image-rbac-proxy
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: oauth-secret-generator
subjects:
- kind: ServiceAccount
  name: oauth-secret-generator
  namespace: image-rbac-proxy
---
apiVersion: batch/v1
kind: Job
metadata:
  name: oauth-secret-generator
  namespace: image-rbac-proxy
  annotations:
    argocd.argoproj.io/sync-options: Force=true,Replace=true
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      containers:
      - command:
        - /bin/bash
        - -c
        - |
          set -o errexit
          set -o nounset
          set -o pipefail

          echo "Generating/updating image-proxy-client-secret"

          random_pass=$(openssl rand -base64 20)
          kubectl create secret generic image-proxy-client-secret \
              --namespace image-rbac-proxy \
              --from-literal="client-secret=${random_pass}" \
              --dry-run=client \
              -o yaml \
              | kubectl apply -f -

          echo "Restarting the proxy deployment"
          if kubectl -n image-rbac-proxy get deployment/image-rbac-proxy; then
            kubectl -n image-rbac-proxy rollout restart deployment/image-rbac-proxy
          else
            echo "skipping restart"
          fi

          echo "Restarting the dex deployment"
          if kubectl -n image-rbac-proxy get deployment/dex; then
            kubectl -n image-rbac-proxy rollout restart deployment/dex
          else
            echo "skipping dex restart"
          fi

        image: quay.io/konflux-ci/appstudio-utils:ab6b0b8e40e440158e7288c73aff1cf83a2cc8a9@sha256:24179f0efd06c65d16868c2d7eb82573cce8e43533de6cea14fec3b7446e0b14
        imagePullPolicy: Always
        name: oauth-secret-generator
        resources:
          limits:
            cpu: 100m
            memory: 250Mi
          requests:
            cpu: 10m
            memory: 10Mi
        securityContext:
          readOnlyRootFilesystem: true
          runAsNonRoot: true
      dnsPolicy: ClusterFirst
      restartPolicy: Never
      serviceAccountName: oauth-secret-generator
      terminationGracePeriodSeconds: 30
