---
apiVersion: kubearchive.org/v1
kind: ClusterKubeArchiveConfig
metadata:
  name: kubearchive
  namespace: product-kubearchive
spec:
  resources:
    - selector:
        apiVersion: appstudio.redhat.com/v1alpha1
        kind: Snapshot
      archiveOnDelete: 'true'
    - selector:
        apiVersion: appstudio.redhat.com/v1alpha1
        kind: Release
      archiveWhen: has(status.completionTime)
      # CEL duration only supports h, m, s, ms, us, ns suffixes, so we convert days to hours
      # Uses gracePeriodDays from Release spec if present (capped at 30 days max), otherwise defaults to 5 days (120h)
      deleteWhen: 'timestamp(metadata.creationTimestamp) < now() - duration(string(has(spec.gracePeriodDays) ? (spec.gracePeriodDays > 30 ? 720 : spec.gracePeriodDays * 24) : 120) + "h")'
    - selector:
        apiVersion: tekton.dev/v1
        kind: PipelineRun
      archiveWhen: has(status.completionTime)
      deleteWhen: has(status.completionTime) && timestamp(metadata.completionTime) < now() - duration("5m")
      archiveOnDelete: 'true'
    - selector:
        apiVersion: tekton.dev/v1
        kind: TaskRun
      archiveWhen: has(status.completionTime)
      archiveOnDelete: 'true'
    - selector:
        apiVersion: v1
        kind: Pod
      archiveWhen: has(metadata.labels) && "tekton.dev/taskRunUID" in metadata.labels && status.phase in ['Succeeded', 'Failed', 'Unknown']
      archiveOnDelete: has(metadata.labels) && "tekton.dev/taskRunUID" in metadata.labels
