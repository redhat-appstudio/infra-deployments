apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

commonAnnotations:
  ignore-check.kube-linter.io/drop-net-raw-capability: |
    "Vector runs requires access to socket."
  ignore-check.kube-linter.io/run-as-non-root: |
    "Vector runs as Root and attach host Path."
  ignore-check.kube-linter.io/sensitive-host-mounts: |
    "Vector runs requires certain host mounts to watch files being created by pods."
  ignore-check.kube-linter.io/pdb-unhealthy-pod-eviction-policy: |
    "Managed by upstream Loki chart (no value exposed for unhealthyPodEvictionPolicy)."
  ignore-check.kube-linter.io/no-read-only-root-fs: |
    "Minio post-jobs from chart require write access to filesystem."
  ignore-check.kube-linter.io/unset-cpu-requirements: |
    "Minio post-job containers from chart do not expose resource configuration options."
  ignore-check.kube-linter.io/unset-memory-requirements: |
    "Minio post-job containers from chart do not expose resource configuration options."

resources:
- ../base
- rbac.yaml
- loki-secret.yaml
- sa.yaml

patches:
  - path: scc-patch.yaml
    target:
      kind: SecurityContextConstraints
      name: kubearchive-logging-scc
  # Patch all Loki PodDisruptionBudgets to allow eviction of unhealthy pods
  # This is critical for StatefulSets where stale pods should be evicted
  - patch: |
      - op: add
        path: /spec/unhealthyPodEvictionPolicy
        value: AlwaysAllow
    target:
      group: policy
      version: v1
      kind: PodDisruptionBudget
      labelSelector: app.kubernetes.io/name=loki
  # Set PVC retention policy to Delete for ingester StatefulSet
  # - path: ingester-pvc-retention-patch.yaml
  #   target:
  #     kind: StatefulSet
  #     name: loki-ingester
  - patch: |
        - op: replace
          path: /spec/persistentVolumeReclaimPolicy/whenDeleted
          value: Delete
          path: /spec/persistentVolumeReclaimPolicy/whenScaled
          value: Delete
    target:
      group: apps
      version: v1
      kind: StatefulSet
      name: loki-ingester
      namespace: product-kubearchive-logging
      labelSelector: app.kubernetes.io/name=loki,app.kubernetes.io/component=ingester

generators:
- vector-helm-generator.yaml
- loki-helm-generator.yaml
- grafana-helm-generator.yaml
