apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

commonAnnotations:
  ignore-check.kube-linter.io/drop-net-raw-capability: |
    "Vector runs requires access to socket."
  ignore-check.kube-linter.io/run-as-non-root: |
    "Vector runs as Root and attach host Path."
  ignore-check.kube-linter.io/sensitive-host-mounts: |
    "Vector runs requires certain host mounts to watch files being created by pods."
  ignore-check.kube-linter.io/pdb-unhealthy-pod-eviction-policy: |
    "Managed by upstream Loki chart (no value exposed for unhealthyPodEvictionPolicy)."

resources:
- ../base

generators:
- vector-helm-generator.yaml
- loki-helm-generator.yaml

patches:
  # Patch all Loki PodDisruptionBudgets to allow eviction of unhealthy pods
  # This is critical for StatefulSets where stale pods should be evicted
  - patch: |
      - op: add
        path: /spec/unhealthyPodEvictionPolicy
        value: AlwaysAllow
    target:
      group: policy
      version: v1
      kind: PodDisruptionBudget
      labelSelector: app.kubernetes.io/name=loki
