apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

commonAnnotations:
  ignore-check.kube-linter.io/drop-net-raw-capability: |
    "Vector runs requires access to socket."
  ignore-check.kube-linter.io/run-as-non-root: |
    "Vector runs as Root and attach host Path."
  ignore-check.kube-linter.io/sensitive-host-mounts: |
    "Vector runs requires certain host mounts to watch files being created by pods."
  ignore-check.kube-linter.io/pdb-unhealthy-pod-eviction-policy: |
    "Managed by upstream Loki chart (no value exposed for unhealthyPodEvictionPolicy)."

resources:
- ../../base
- rbac.yaml
- loki-secret.yaml

generators:
- vector-helm-generator.yaml
- loki-helm-generator.yaml
- grafana-helm-generator.yaml

patches:
- patch: |-
    apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: kubearchive-loki
      namespace: product-kubearchive-logging
    spec:
      dataFrom:
        - extract:
            key: staging/kubearchive/loki
      refreshInterval: 5m
      secretStoreRef:
        kind: ClusterSecretStore
        name: appsre-stonesoup-vault
      target:
        creationPolicy: Orphan
        name: kubearchive-loki
        template:
          metadata:
            annotations:
              argocd.argoproj.io/sync-options: Prune=false
