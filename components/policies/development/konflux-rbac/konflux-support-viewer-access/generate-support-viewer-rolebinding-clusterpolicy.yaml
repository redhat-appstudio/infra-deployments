---
# This ClusterPolicy automatically generates a RoleBinding in all tenant namespaces
# to grant read-only access to the 'konflux-sre' and 'ai-konflux-user-support' groups.
#
# This policy is designed to ensure that these groups have consistent
# visibility across tenant namespaces for monitoring, troubleshooting, or support.

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: generate-konflux-support-read-only-rolebinding
  annotations:
    policies.kyverno.io/title: "Generate Read-Only RoleBinding for Konflux support and sre Groups"
    policies.kyverno.io/category: Multi-Tenancy
    policies.kyverno.io/description: >-
      This policy automatically generates a RoleBinding in all tenant namespaces.
      The RoleBinding binds the 'konflux-sre' and 'ai-konflux-user-support'
      groups to the Konflux-specific 'konflux-viewer-user-actions' ClusterRole,
      granting them comprehensive read-only access to resources within each tenant namespace,
      therefore allowing better, fast and streamlined support.
spec:
  background: false
  rules:
    - name: generate-read-only-rolebinding
      match:
        any:
        - resources:
            kinds:
            - /v1/Namespace
            selector:
              matchLabels:
                konflux-ci.dev/type: tenant
      generate:
        generateExisting: true
        synchronize: true
        apiVersion: rbac.authorization.k8s.io/v1
        kind: RoleBinding
        name: konflux-read-only-binding
        namespace: "{{request.object.metadata.name}}"
        data:
          subjects:
            - kind: Group
              name: konflux-sre
              apiGroup: rbac.authorization.k8s.io
            - kind: Group
              name: ai-konflux-user-support
              apiGroup: rbac.authorization.k8s.io
          roleRef:
            kind: ClusterRole
            name: konflux-viewer-user-actions
            apiGroup: rbac.authorization.k8s.io
