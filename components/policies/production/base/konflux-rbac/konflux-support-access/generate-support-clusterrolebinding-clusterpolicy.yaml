---
# This ClusterPolicy automatically generates a ClusterRoleBinding for users
# in the 'ai-konflux-user-support' Group to enable namespace-lister access.
#
# The namespace-lister service checks for ClusterRoleBindings with the label
# 'namespace-lister.konflux-ci.dev/use-for-access: true' and grants access
# to tenant namespaces based on individual User subjects in those bindings.

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: generate-konflux-support-crb
  annotations:
    policies.kyverno.io/title: "Generate ClusterRoleBinding for ai-konflux-user-support Group Users"
    policies.kyverno.io/category: Multi-Tenancy
    policies.kyverno.io/description: >-
      This policy automatically generates a ClusterRoleBinding for all users
      in the 'ai-konflux-user-support' Group. The ClusterRoleBinding includes the
      label 'namespace-lister.konflux-ci.dev/use-for-access: true' which
      enables namespace-lister to grant these users access to tenant namespaces.
      The binding is synchronized with the Group, so any changes to group
      membership are automatically reflected in the ClusterRoleBinding.
spec:
  background: true
  rules:
    - name: generate-nslister-clusterrolebinding
      skipBackgroundRequests: true
      match:
        any:
        - resources:
            kinds:
            - user.openshift.io/v1/Group
            names:
            - ai-konflux-user-support
            - konflux-sre
            - plm-poe
      context:
        - name: userSubjects
          variable:
            jmesPath: "request.object.users[] | [].{kind: 'User', apiGroup: 'rbac.authorization.k8s.io', name: @}"
      generate:
        generateExisting: true
        synchronize: true
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        name: "konflux-support-{{request.object.metadata.name}}"
        data:
          metadata:
            labels:
              namespace-lister.konflux-ci.dev/use-for-access: 'true'
          subjects: "{{ userSubjects }}"
          roleRef:
            kind: ClusterRole
            name: konflux-viewer-user-actions
            apiGroup: rbac.authorization.k8s.io
