# Network Policy: DNS Egress
#
# Purpose: Allow the external-secrets pods to communicate with DNS (for name resolution)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: external-secrets-operator
spec:
  # Selects ALL ESO Pods: main-controller, webhook, and cert-controller
  podSelector:
    matchLabels:
      app.kubernetes.io/instance: external-secrets-operator
  policyTypes:
  - Egress
  egress:
  # Allow DNS queries to both the DNS pods and the DNS service (ClusterIP)
  # The DNS service is typically at 172.30.0.10 in the service network
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: openshift-dns
    - ipBlock:
        cidr: 172.30.0.10/32
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
---
# Network Policy: Main Controller Egress
#
# Purpose: Allow the main external-secrets controller to communicate with:
#   - Kubernetes API server (for watching CRDs, updating satus)
#   - External secret providers (AWS, GCP, Vault, etc.)
#   - OpenShift internal services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-main-controller-egress
  namespace: external-secrets-operator
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/instance: external-secrets-operator
      app.kubernetes.io/name: external-secrets
  policyTypes:
  - Egress
  egress:
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
---
# Network Policy: Cert Controller and Webhook Egress
#
# Purpose: Allow the cert-controller and webhook to communicate with
# Kubernetes API server:
#   - cert-controller: for managing webhook certificates
#   - webhook: for CRD validation and cert management
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-cert-controller-webhook-egress
  namespace: external-secrets-operator
spec:
  podSelector:
    matchExpressions:
    - key: app.kubernetes.io/name
      operator: In
      values:
      - external-secrets-cert-controller
      - external-secrets-webhook
    matchLabels:
      app.kubernetes.io/instance: external-secrets-operator
  policyTypes:
  - Egress
  egress:
  # Allow egress to Kubernetes API server
  # As kube-apiserver uses host network, support multiple cluster
  # configurations with different network CIDRs
  - to:
    # kubernetes default service
    - ipBlock:
        cidr: 172.30.0.1/32
    # Aggregated node network for internal clusters (10.28.x.x - 10.29.x.x)
    - ipBlock:
        cidr: 10.28.0.0/15
    # Aggregated node network for public clusters (10.200 - 10.210)
    - ipBlock:
        cidr: 10.192.0.0/11
    ports:
      - protocol: TCP
        port: 443
      - protocol: TCP
        port: 6443

