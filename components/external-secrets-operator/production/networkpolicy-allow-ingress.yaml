---
# Network Policy: Webhook Ingress
#
# Purpose: Allow incoming traffic to the validating webhook on port 10250 from:
#   - Kubernetes API server (required for CRD validation)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-webhook-ingress
  namespace: external-secrets-operator
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/instance: external-secrets-operator
      app.kubernetes.io/name: external-secrets-webhook
  policyTypes:
  - Ingress
  ingress:
  - from:
    # Allow webhook traffic from Kubernetes API server
    # The kube-apiserver uses host network (node IPs) but the call
    # is NATed and comes from a pod IP assigned to interface ovn-k8s-mp0
    # - 192.168.0.0/16 (pod CIDR in most clusters)
    # - 10.128.0.0/14 (pod CIDR in stg-rh01, prd-rh01 and prd-p01 clusters)
    - ipBlock:
        cidr: 10.128.0.0/14
    - ipBlock:
        cidr: 192.168.0.0/16
    ports:
    - protocol: TCP
      port: 10250 # Webhook port
---
# Network Policy: Metrics Ingress
#
# Purpose: Allow Prometheus/monitoring systems to scrape metrics from all ESO components
# Port: 8080 (metrics endpoint)
#
# Allows traffic from:
#   - appstudio-workload-monitoring namespace
#   - openshift-monitoring namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-metrics-ingress
  namespace: external-secrets-operator
spec:
  # Selects ALL ESO Pods (Controller, Webhook, Cert Controller)
  podSelector:
    matchLabels:
      app.kubernetes.io/instance: external-secrets-operator
  policyTypes:
  - Ingress
  ingress:
  - from:
    # Allow Prometheus to scrape metrics
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: appstudio-workload-monitoring
    # Also allow from openshift-monitoring if it exists
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: openshift-monitoring
    ports:
    - protocol: TCP
      port: 8080  # Metrics port
---
# Network Policy: Health Checks
#
# Purpose: Allow liveness/readiness probes on all ESO components
# Port: 8081 (health check endpoint)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-health-checks-ingress
  namespace: external-secrets-operator
spec:
  # Selects ALL ESO Pods (Controller, Webhook, Cert Controller)
  podSelector:
    matchLabels:
      app.kubernetes.io/instance: external-secrets-operator
  policyTypes:
  - Ingress
  ingress:
  # Allow health checks on port 8081
  - from:
    - ipBlock:
        cidr: 10.128.0.0/14
    - ipBlock:
        cidr: 192.168.0.0/16
    ports:
    - protocol: TCP
      port: 8081

