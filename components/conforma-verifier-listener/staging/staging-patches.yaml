---
# Staging-specific patches for Conforma Verifier Listener
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: conforma-verifier-listener
  annotations:
    # VSA attestation support for staging
    chains.tekton.dev/signed: "true"
spec:
  template:
    metadata:
      annotations:
        # Staging scaling configuration
        autoscaling.knative.dev/minScale: "1"
        autoscaling.knative.dev/maxScale: "3"
        autoscaling.knative.dev/target: "10"
        # Enhanced logging for staging
        logging.knative.dev/config: "debug"
    spec:
      containerConcurrency: 10
      containers:
        - image: quay.io/conforma/knative-service:latest
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          env:
            - name: LOG_LEVEL
              value: "debug"
            - name: ENVIRONMENT
              value: "staging"

---
# Enhanced RBAC for staging with VSA attestation support
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: conforma-verifier-listener
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list"]
  - apiGroups: ["tekton.dev"]
    resources: ["taskruns"]
    verbs: ["create", "get", "list", "watch"]
  - apiGroups: ["appstudio.redhat.com"]
    resources: ["snapshots"]
    verbs: ["get", "list", "watch"]
  # Additional permissions for VSA attestation
  - apiGroups: ["tekton.dev"]
    resources: ["pipelineruns"]
    verbs: ["get", "list", "watch"]
