apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: konflux-admins
  annotations:
    description: "Konflux admin role with cluster-admin permissions except secrets and internalrequests access"
rules:
  # Grant permissions on appstudio.redhat.com resources EXCEPT internalrequests
  # internalrequests are intentionally excluded for security reasons
  - apiGroups:
      - appstudio.redhat.com
    resources:
      - applications
      - buildpipelineselectors
      - componentdetectionqueries
      - components
      - dependencyupdatechecks
      - deploymenttargetclaims
      - deploymenttargetclasses
      - deploymenttargets
      - enterprisecontractpolicies
      - environments
      - imagerepositories
      - integrationtestscenarios
      # internalrequests - INTENTIONALLY EXCLUDED
      - internalservicesconfigs
      - promotionruns
      - releaseplanadmissions
      - releaseplans
      - releases
      - releases/status
      - releaseserviceconfigs
      - releasestrategies
      - remotesecrets
      - snapshotenvironmentbindings
      - snapshots
      - spiaccesschecks
      - spiaccesstokenbindings
      - spiaccesstokendataupdates
      - spiaccesstokens
      - spifilecontentrequests
    verbs:
      - '*'
  # Grant READ-ONLY access (plus delete) to API groups that can create pods
  # These can be used to create pods which could access secrets
  # Delete is allowed for cleanup, but create/update/patch are blocked
  - apiGroups:
      - apps
      - apps.openshift.io
      - argoproj.io
      - batch
      - operator.tekton.dev
      - tekton.dev
    resources:
      - '*'
    verbs:
      - get
      - list
      - watch
      - delete
  # Grant all permissions on ALL other non-core API groups
  # These API groups cannot be used to create pods or access secrets
  - apiGroups:
      - acme.cert-manager.io
      - addon.open-cluster-management.io
      - addons.managed.openshift.io
      - admissionregistration.k8s.io
      - agent-install.openshift.io
      - apiextensions.crossplane.io
      - apiextensions.k8s.io
      - apiregistration.k8s.io
      - apiserver.openshift.io
      - authentication.k8s.io
      - authorization.k8s.io
      - authorization.openshift.io
      - autoscaling
      - autoscaling.openshift.io
      - bootstrap.cluster.x-k8s.io
      - build.openshift.io
      - capi-provider.agent-install.openshift.io
      - certificates.hypershift.openshift.io
      - certificates.k8s.io
      - cert-manager.io
      - cloudcredential.openshift.io
      - cloud.network.openshift.io
      - cluster.open-cluster-management.io
      - clustertemplate.openshift.io
      - clusterview.open-cluster-management.io
      - cluster.x-k8s.io
      - confidentialcontainers.org
      - config.openshift.io
      - console.openshift.io
      - controlplane.cluster.x-k8s.io
      - controlplane.operator.openshift.io
      - coordination.k8s.io
      - costmanagement-metrics-cfg.openshift.io
      - datamover.oadp.openshift.io
      - dex.coreos.com
      - discovery.k8s.io
      - dynatrace.com
      - eaas.konflux-ci.dev
      - events.k8s.io
      - eventing.knative.dev
      - external-secrets.io
      - extensions
      - extensions.hive.openshift.io
      - flows.knative.dev
      - flowcontrol.apiserver.k8s.io
      - generators.external-secrets.io
      - gotemplating.fn.crossplane.io
      - grafana.integreatly.org
      - helm.openshift.io
      - hiveinternal.openshift.io
      - hive.openshift.io
      - hypershift.openshift.io
      - image.openshift.io
      - imageregistry.operator.openshift.io
      - infrastructure.cluster.x-k8s.io
      - ingress.operator.openshift.io
      - integreatly.org
      - ipam.cluster.x-k8s.io
      - ipam.metal3.io
      - jvmbuildservice.io
      - k8s.cni.cncf.io
      - k8s.ovn.org
      - kataconfiguration.openshift.io
      - kepler.system.sustainable.computing.io
      - keycloak.org
      - kubearchive.kubearchive.org
      - kubearchive.org
      - kueue.openshift.io
      - kueue.x-k8s.io
      - kubernetes.crossplane.io
      - kubernetes.m.crossplane.io
      - kyverno.io
      - logging.openshift.io
      - machineconfiguration.openshift.io
      - machine.openshift.io
      - managed-gitops.redhat.com
      - managed.openshift.io
      - messaging.knative.dev
      - metal3.io
      - metrics.k8s.io
      - migration.k8s.io
      - monitoring.coreos.com
      - monitoring.openshift.io
      - monitoring.rhobs
      - multicluster.openshift.io
      - network.openshift.io
      - network.operator.openshift.io
      - networking.k8s.io
      - node.k8s.io
      - oadp.openshift.io
      - oauth.openshift.io
      - observability.openshift.io
      - ocmagent.managed.openshift.io
      - open-cluster-management.io
      - operators.coreos.com
      - operator.external-secrets.io
      - operator.open-cluster-management.io
      - operator.openshift.io
      - ops.crossplane.io
      - package-operator.run
      - packages.operators.coreos.com
      - performance.openshift.io
      - perses.dev
      - pipelinesascode.tekton.dev
      - pipelines.openshift.io
      - pkg.crossplane.io
      - pt.fn.crossplane.io
      - policies.kyverno.io
      - policy
      - policy.networking.k8s.io
      - projctl.konflux.dev
      - project.openshift.io
      - protection.crossplane.io
      - pulp.konflux-ci.dev
      - quota.openshift.io
      - rbac.authorization.k8s.io
      - redhatcop.redhat.io
      - reports.kyverno.io
      - resolution.tekton.dev
      - rhdh.redhat.com
      - route.openshift.io
      - runtime.cluster.x-k8s.io
      - samples.operator.openshift.io
      - scheduling.hypershift.openshift.io
      - scheduling.k8s.io
      - secrets.crossplane.io
      - security.internal.openshift.io
      - security.openshift.io
      - sharedresource.openshift.io
      - singapore.open-cluster-management.io
      - sinks.knative.dev
      - snapshot.storage.k8s.io
      - sources.knative.dev
      - splunkforwarder.managed.openshift.io
      - storage.k8s.io
      - template.openshift.io
      - triggers.tekton.dev
      - trust.cert-manager.io
      - tuned.openshift.io
      - upgrade.managed.openshift.io
      - user.openshift.io
      - velero.io
      - whereabouts.cni.cncf.io
      - wgpolicyk8s.io
      - work.open-cluster-management.io
      - workspaces.konflux-ci.dev
      - workspaces.konflux.io
    resources:
      - '*'
    verbs:
      - '*'
  # Grant all permissions on SAFE core API group resources
  # These resources cannot be used to access secrets
  - apiGroups:
      - ''
    resources:
      - componentstatuses
      - configmaps
      - endpoints
      - events
      - limitranges
      - namespaces
      - namespaces/finalize
      - namespaces/status
      - nodes
      - nodes/proxy
      - nodes/status
      - persistentvolumeclaims
      - persistentvolumeclaims/status
      - persistentvolumes
      - persistentvolumes/status
      - resourcequotas
      - resourcequotas/status
      - serviceaccounts
      - serviceaccounts/token
      - services
      - services/proxy
      - services/status
      # NOTE: 'secrets' is intentionally omitted from this list
    verbs:
      - '*'
  # Grant READ-ONLY access (plus delete) to pod-related resources
  # Creating/exec'ing pods can be used to access secrets, so create/update/patch are blocked
  # Delete is allowed for cleanup
  - apiGroups:
      - ''
    resources:
      - pods
      - pods/attach
      - pods/binding
      - pods/ephemeralcontainers
      - pods/eviction
      - pods/exec
      - pods/log
      - pods/portforward
      - pods/proxy
      - pods/status
      - podtemplates
      - replicationcontrollers
      - replicationcontrollers/scale
      - replicationcontrollers/status
    verbs:
      - get
      - list
      - watch
      - delete
  # Grant all permissions on non-resource URLs
  - nonResourceURLs:
      - '*'
    verbs:
      - '*'
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: konflux-admins
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: konflux-admins
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: Group
    name: konflux-admins
