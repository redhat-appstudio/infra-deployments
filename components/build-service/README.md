---
title: StoneSoup Build System
---

The StoneSoup Build System is composed of the following components:

- [OpenShift Pipelines](https://docs.openshift.com/container-platform/4.10/cicd/pipelines/understanding-openshift-pipelines.html)
- [Tekton Chains](https://github.com/tektoncd/chains)
- [Tekton Results](https://github.com/tektoncd/results)
- [Pipelines as Code](https://pipelinesascode.com/)
- [Shared Resources](https://github.com/openshift/csi-driver-shared-resource)
- [App Studio Build Service](https://github.com/redhat-appstudio/build-service/)
- [HACBS JVM Build Service](https://github.com/redhat-appstudio/jvm-build-service)
- [PVC Cleaner](https://github.com/redhat-appstudio/pvc-cleaner/)

This repository installs all the components and includes a set of example scripts that simplify usage and provide examples of a working system. There are no additional components needed to use the build system API, however some utilities and scripts are provided to demonstrate functionality.

## Quickstart

To try out a pre-configured, follow these steps.

| Steps    |    |
| ----------- | ----------- |
| 1.  Create project for your pipelines execution. This can be run as any non-admin user (or admin)  and is needed to hold your execution pipelines.  |  oc new-project demo     |
| 2.  Run build-deploy example with a quarkus app. | MY_QUAY_USER=mkovarik ./hack/build/build-via-appstudio.sh https://github.com/devfile-samples/devfile-sample-code-with-quarkus
| 3.  View your build on the OpenShift Console under the pipelines page or view the logs via CLI. | `tkn pipelinerun logs`      |

## Tests via StoneSoup

To validate execution via StoneSoup you can run `./hack/build/build-via-appstudio.sh` script which sets credentials and StoneSoup application and components. Without parameters it creates example components.

```
export MY_QUAY_USER=mkovarik
./hack/build/build-via-appstudio.sh https://github.com/devfile-samples/devfile-sample-java-springboot-basic
```

To enable PipelineAsCode integration you need to set `PIPELINESASCODE` env variable to `1` and also have to have set GitHub credentials in your `./hack/preview.env`.
One may use GitHub PipelineAsCode application or webhook.
To use GitHub application set `PAC_GITHUB_APP_PRIVATE_KEY` and `PAC_GITHUB_APP_ID` in your `./hack/preview.env`.
Alternatively, to use GitHub webhook set `PAC_GITHUB_TOKEN` with [required permissions](https://pipelinesascode.com/docs/install/github_webhook/#create-github-personal-access-token) or make sure that `MY_GITHUB_TOKEN` set and has the required permissions.
Then run:

```
MY_QUAY_USER=mkovarik PIPELINESASCODE=1 ./hack/build/build-via-appstudio.sh https://github.com/Michkov/devfile-sample-go-basic
```

### Change of default pipeline bundle

Pipeline bundles are generated by [build-definitions](https://github.com/redhat-appstudio/build-definitions).

By default, the bundle is defined in `components/build-service/build-pipeline-selector.yaml`. To use alternative pipeline bundles rather than the default ones, either update every predefined `.spec.selectors[].pipelineRef.bundle` in this file and provision cluster again, or create a custom `BuildPipelineSelector` CR in your own namespace.

### Stage Cluster integration prerequisites

Before creating component in Stage cluster it's necessary install GitHub application [AppStudio Staging CI](https://github.com/apps/appstudio-staging-ci) into managed repository or into whole GitHub organization.

## Shared Resources

Shared Secrets are provided to be used by projects, secrets is defined in one project but can be used by other projects.

Available secrets:

| Name | Source | Description | Access |
| -- | -- | -- | -- |
| redhat-appstudio-user-workload | redhat-appstudio-user-workload secret in build-templates namespace | Quay secret allowing to push into default AppStudio repository | users/serviceaccounts with edit role |

### Repository secrets

There are three ways to provide repository secret into PipelineRun.

By priority (1. is highest):

1. `redhat-appstudio-registry-pull-secret` secret in the execution namespace
2. linked secret to `pipeline` service account in the execution namespace
3. shared secret `redhat-appstudio-user-workload`

### Use SharedSecret with Tekton Chains

During the build pipeline, it is possible to use the `redhat-appstudio-user-workload`
[SharedSecret](https://github.com/openshift/csi-driver-shared-resource) to specify the credentials
for pushing container images. If this is used, Tekton Chains must also be configured to use the
same `SharedSecret`. This is done by default. However, the `Secret` referred to by the
`SharedSecret` may not exist at bootstrap time. This is ok. The underlying `Secret` can be created
at a later time, and/or updated as needed. The changes should be reflected automatically within the
Tekton Chains Controller without requiring a Pod restart.

## Build Service secrets

List of secrets:

| Name | Source | Description |
| -- | -- | -- |
| pipelines-as-code-secret | appsre vault | Secret containg 'github-application-id', 'github-private-key' and 'webhook.secret' of GitHub Application used by Build service for creating pull-requests |

Rotation rule: Secrets must be rotated within 7 days after someone with access leaves the organization. Secrets older than one year should be rotated.

### Instructions for rotation of pipelines-as-code-secret

Prerequisite:
- User must have admin role on the organization owning the GitHub Application.
- The GitHub Application is shared between Build team and Pipeline Service team - both teams must be aware of the rotation

Process for production instance:
1. Go to https://github.com/organizations/redhat-appstudio/settings/apps/red-hat-trusted-app-pipeline
2. In section 'Webhook secret (optional)' - click on Change Secret
3. In section 'Private Keys' - generate new private key and remove the old one.
4. Put new secrets from step 2. and 3. to app-sre vault to `stonesoup/production/pipeline-service/github-app` and `stonesoup/production/build/build-service`

Process for stage instance:
1. Go to https://github.com/organizations/redhat-appstudio/settings/apps/rhtap-staging
2. In section 'Webhook secret (optional)' - click on Change Secret
3. In section 'Private Keys' - generate new private key and remove the old one.
4. Put new secrets from step 2. and 3. to app-sre vault to `stonesoup/staging/pipeline-service/github-app` and `stonesoup/staging/build/build-service`