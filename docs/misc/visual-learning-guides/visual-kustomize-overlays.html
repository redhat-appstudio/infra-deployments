<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Understanding Kustomize Overlays - Visual Guide</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .concept-box {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .concept-box h2 {
            font-size: 2em;
            margin-bottom: 15px;
        }
        
        .section {
            background: white;
            border-radius: 10px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 2em;
            color: #2d3748;
            margin-bottom: 25px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }
        
        .structure-diagram {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            white-space: pre-wrap;
            line-height: 1.8;
        }
        
        .folder {
            color: #ed8936;
            font-weight: bold;
        }
        
        .file {
            color: #4299e1;
        }
        
        .comment {
            color: #a0aec0;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        
        .comparison-column {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 3px solid;
        }
        
        .comparison-column.base {
            border-color: #667eea;
        }
        
        .comparison-column.overlay {
            border-color: #48bb78;
        }
        
        .comparison-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .code-block {
            background: #2d3748;
            color: #68d391;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 15px 0;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .code-highlight {
            color: #fbbf24;
            font-weight: bold;
        }
        
        .code-comment {
            color: #a0aec0;
        }
        
        .example-box {
            background: #c6f6d5;
            border: 2px solid #48bb78;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .example-title {
            color: #2f855a;
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        
        .warning-box {
            background: #fff5f5;
            border-left: 4px solid #f56565;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .warning-box h3 {
            color: #c53030;
            margin-bottom: 10px;
        }
        
        .info-box {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .info-box h3 {
            color: #2c5282;
            margin-bottom: 10px;
        }
        
        .visual-flow {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin: 30px 0;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .flow-box {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            min-width: 150px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .flow-arrow {
            font-size: 2em;
            color: #667eea;
        }
        
        .layer-stack {
            position: relative;
            height: 400px;
            margin: 40px auto;
            max-width: 600px;
        }
        
        .layer {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            padding: 25px;
            border-radius: 10px;
            border: 3px solid;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .layer:hover {
            z-index: 10;
            transform: translateX(-50%) scale(1.05);
        }
        
        .layer-base {
            bottom: 0;
            background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
            border-color: #4299e1;
            z-index: 1;
        }
        
        .layer-dev {
            bottom: 80px;
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            border-color: #48bb78;
            z-index: 2;
        }
        
        .layer-staging {
            bottom: 160px;
            background: linear-gradient(135deg, #fffaf0 0%, #feebc8 100%);
            border-color: #ed8936;
            z-index: 3;
        }
        
        .layer-prod {
            bottom: 240px;
            background: linear-gradient(135deg, #fed7d7 0%, #fc8181 100%);
            border-color: #f56565;
            z-index: 4;
        }
        
        .layer-title {
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        
        .layer-description {
            font-size: 0.9em;
            color: #2d3748;
        }
        
        .best-practices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .practice-card {
            background: #f8f9fa;
            border-left: 4px solid #48bb78;
            padding: 20px;
            border-radius: 5px;
        }
        
        .practice-card h4 {
            color: #2f855a;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .antipattern-card {
            background: #fff5f5;
            border-left: 4px solid #f56565;
            padding: 20px;
            border-radius: 5px;
        }
        
        .antipattern-card h4 {
            color: #c53030;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        @media (max-width: 968px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .layer-stack {
                height: auto;
                position: static;
            }
            
            .layer {
                position: static;
                transform: none !important;
                margin-bottom: 20px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">â† Back to Visual Guide Index</a>
        
        <div class="header">
            <h1>ğŸ¨ Understanding Kustomize Overlays</h1>
            <p>The Complete Guide to infra-deployments Structure</p>
        </div>
        
        <div class="concept-box">
            <h2>ğŸ¤” What Are Kustomize Overlays?</h2>
            <p style="font-size: 1.15em; line-height: 1.7; margin-top: 15px;">
                <strong>Kustomize overlays</strong> are a powerful pattern for managing Kubernetes manifests across 
                multiple environments (dev, staging, production) <strong>without duplicating YAML files</strong>. 
                You define a <strong>base</strong> with common configuration, then create <strong>overlays</strong> 
                that patch/modify the base for each specific environment.
            </p>
            <p style="font-size: 1.15em; line-height: 1.7; margin-top: 15px;">
                <strong>In Konflux:</strong> Every component uses this pattern. The base defines what the service IS. 
                The overlays define HOW it runs in each environment (different replicas, resources, images, configs).
            </p>
        </div>
        
        <!-- The Problem: Without Overlays -->
        <div class="section">
            <h2 class="section-title">âŒ The Problem: Without Overlays</h2>
            
            <div class="warning-box">
                <h3>Imagine managing 50+ components across 3 environments...</h3>
                <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                    <li>Without overlays: <strong>50 Ã— 3 = 150 nearly-identical YAML files</strong></li>
                    <li>Change service name? Update 150 files!</li>
                    <li>Add new label? Update 150 files!</li>
                    <li>99% duplication, nightmare to maintain</li>
                </ul>
            </div>
            
            <div class="code-block">
<span class="code-comment"># Without overlays, you'd have files like:</span>
components/build-service-dev.yaml       <span class="code-comment"># 500 lines</span>
components/build-service-staging.yaml   <span class="code-comment"># 500 lines (95% identical!)</span>
components/build-service-prod.yaml      <span class="code-comment"># 500 lines (95% identical!)</span>

<span class="code-comment"># And this for EVERY component... ğŸ˜±</span>
            </div>
        </div>
        
        <!-- The Solution: Overlays -->
        <div class="section">
            <h2 class="section-title">âœ… The Solution: Kustomize Overlays</h2>
            
            <div class="info-box">
                <h3>With overlays:</h3>
                <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                    <li><strong>1 base</strong> with common configuration (shared by all environments)</li>
                    <li><strong>3 small overlays</strong> with only environment-specific differences</li>
                    <li>Change service name? Update base once, all environments inherit it!</li>
                    <li>~95% reduction in duplication</li>
                </ul>
            </div>
            
            <div class="layer-stack">
                <div class="layer layer-base">
                    <div class="layer-title">ğŸ“¦ Base Layer</div>
                    <div class="layer-description">
                        Common manifests: Deployment, Service, ServiceAccount, RBAC
                    </div>
                </div>
                
                <div class="layer layer-dev">
                    <div class="layer-title">ğŸŸ¢ Development Overlay</div>
                    <div class="layer-description">
                        Patches: 1 replica, debug logging, latest image
                    </div>
                </div>
                
                <div class="layer layer-staging">
                    <div class="layer-title">ğŸŸ¡ Staging Overlay</div>
                    <div class="layer-description">
                        Patches: 2 replicas, info logging, tested image
                    </div>
                </div>
                
                <div class="layer layer-prod">
                    <div class="layer-title">ğŸ”´ Production Overlay</div>
                    <div class="layer-description">
                        Patches: 3 replicas, error logging, stable image, resource limits
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Real Structure -->
        <div class="section">
            <h2 class="section-title">ğŸ“ Real infra-deployments Structure</h2>
            
            <p style="font-size: 1.1em; color: #4a5568; margin-bottom: 20px;">
                Here's the actual structure used for EVERY component in infra-deployments:
            </p>
            
            <!-- Visual Structure Diagram -->
            <div style="background: #f8f9fa; border: 2px solid #667eea; border-radius: 10px; padding: 30px; margin: 20px 0;">
                <div style="font-size: 1.3em; font-weight: bold; color: #ed8936; margin-bottom: 20px;">
                    ğŸ“ components/build-service/
                </div>
                
                <!-- Base -->
                <div style="background: #ebf8ff; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #4299e1;">
                    <div style="font-weight: bold; color: #2c5282; margin-bottom: 8px;">ğŸ“ base/ <span style="font-weight: normal; color: #4a5568;">â€” Common resources for ALL environments</span></div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-left: 20px;">
                        <code style="background: #bee3f8; padding: 4px 10px; border-radius: 4px; font-size: 0.85em;">kustomization.yaml</code>
                        <code style="background: #bee3f8; padding: 4px 10px; border-radius: 4px; font-size: 0.85em;">deployment.yaml</code>
                        <code style="background: #bee3f8; padding: 4px 10px; border-radius: 4px; font-size: 0.85em;">service.yaml</code>
                        <code style="background: #bee3f8; padding: 4px 10px; border-radius: 4px; font-size: 0.85em;">rbac.yaml</code>
                    </div>
                </div>
                
                <!-- Development -->
                <div style="background: #f0fff4; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #48bb78;">
                    <div style="font-weight: bold; color: #2f855a; margin-bottom: 8px;">ğŸ“ development/ <span style="font-weight: normal; color: #4a5568;">â€” Dev environment overlay</span></div>
                    <div style="margin-left: 20px;">
                        <code style="background: #c6f6d5; padding: 4px 10px; border-radius: 4px; font-size: 0.85em;">kustomization.yaml</code>
                        <span style="color: #718096; font-size: 0.85em; margin-left: 8px;">Patches base for dev</span>
                    </div>
                </div>
                
                <!-- Staging -->
                <div style="background: #fffaf0; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #ed8936;">
                    <div style="font-weight: bold; color: #c05621; margin-bottom: 8px;">ğŸ“ staging/base/ <span style="font-weight: normal; color: #4a5568;">â€” Staging environment overlay</span></div>
                    <div style="margin-left: 20px;">
                        <code style="background: #feebc8; padding: 4px 10px; border-radius: 4px; font-size: 0.85em;">kustomization.yaml</code>
                        <span style="color: #718096; font-size: 0.85em; margin-left: 8px;">Patches base for staging</span>
                    </div>
                </div>
                
                <!-- Production -->
                <div style="background: #fff5f5; border-radius: 8px; padding: 15px; border-left: 4px solid #f56565;">
                    <div style="font-weight: bold; color: #c53030; margin-bottom: 8px;">ğŸ“ production/base/ <span style="font-weight: normal; color: #4a5568;">â€” Production environment overlay</span></div>
                    <div style="margin-left: 20px;">
                        <code style="background: #fed7d7; padding: 4px 10px; border-radius: 4px; font-size: 0.85em;">kustomization.yaml</code>
                        <span style="color: #718096; font-size: 0.85em; margin-left: 8px;">Patches base for production</span>
                    </div>
                </div>
                
                <div style="background: #e2e8f0; padding: 12px; border-radius: 5px; margin-top: 15px; font-size: 0.9em; color: #4a5568;">
                    <strong>Note:</strong> staging/ and production/ have an extra /base/ subdirectory because they have additional sub-overlays for stone-* clusters.
                </div>
            </div>
            
            <div class="info-box">
                <h3>ğŸ“Œ Key Insight:</h3>
                <p style="margin-top: 10px; line-height: 1.6;">
                    The <code>base/</code> directory contains <strong>actual YAML manifests</strong>. 
                    The overlay directories contain <strong>only kustomization.yaml files</strong> that reference 
                    the base and apply patches. This is the DRY (Don't Repeat Yourself) principle in action!
                </p>
            </div>
        </div>
        
        <!-- Real Example -->
        <div class="section">
            <h2 class="section-title">ğŸ¯ Real Example: build-service</h2>
            
            <div class="comparison-grid">
                <div class="comparison-column base">
                    <div class="comparison-title">Base (Shared)</div>
                    <div class="code-block">
<span class="code-comment"># base/kustomization.yaml</span>
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- deployment.yaml
- service.yaml
- rbac.yaml

<span class="code-comment"># Common labels for all environments</span>
commonLabels:
  app: build-service
  app.kubernetes.io/name: build-service
                    </div>
                    <div style="margin-top: 15px; color: #4a5568; line-height: 1.6;">
                        This base is referenced by ALL overlays. Changes here affect dev, staging, AND production.
                    </div>
                </div>
                
                <div class="comparison-column overlay">
                    <div class="comparison-title">Development Overlay</div>
                    <div class="code-block">
<span class="code-comment"># development/kustomization.yaml</span>
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

<span class="code-highlight">bases:</span>
<span class="code-highlight">- ../base</span>  <span class="code-comment">â† References common base!</span>

<span class="code-comment"># Dev-specific image (gets updated by Renovate)</span>
<span class="code-highlight">images:</span>
<span class="code-highlight">- name: quay.io/konflux-ci/build-service</span>
<span class="code-highlight">  newTag: abc123def456...</span>

<span class="code-comment"># Dev-specific patches</span>
patches:
- target:
    kind: Deployment
    name: build-service
  patch: |-
    - op: replace
      path: /spec/replicas
      value: 1  <span class="code-comment">â† Only 1 replica in dev</span>
                    </div>
                    <div style="margin-top: 15px; color: #4a5568; line-height: 1.6;">
                        This overlay adds/modifies ONLY what's different for development. Everything else comes from base!
                    </div>
                </div>
            </div>
            
            <div class="example-box">
                <div class="example-title">ğŸ” What Happens When You Run Kustomize Build?</div>
                <div class="code-block" style="background: white; color: #2d3748; margin-top: 15px;">
$ kubectl kustomize components/build-service/development

<span class="code-comment"># Kustomize process:</span>
1. Read base/kustomization.yaml
2. Load all resources: deployment.yaml, service.yaml, rbac.yaml
3. Apply commonLabels from base
4. Read development/kustomization.yaml
5. <span class="code-highlight">Apply image tag patch</span> (newTag: abc123...)
6. <span class="code-highlight">Apply replica patch</span> (replicas: 1)
7. Output final, merged YAML

<span class="code-comment"># Result: Full Kubernetes manifests ready to apply!</span>
<span class="code-comment"># The manifests have base content + dev-specific patches</span>
                </div>
            </div>
        </div>
        
        <!-- Common Patterns -->
        <div class="section">
            <h2 class="section-title">ğŸ¨ Common Overlay Patterns in Konflux</h2>
            
            <div class="best-practices-grid">
                <div class="practice-card">
                    <h4>âœ… Image Tag Overrides</h4>
                    <div class="code-block" style="margin-top: 10px;">
images:
- name: quay.io/konflux-ci/service
  newTag: <span class="code-highlight">different-per-env</span>
                    </div>
                    <p style="margin-top: 10px; color: #4a5568;">
                        <strong>Why:</strong> Dev uses latest, staging uses tested, prod uses stable.
                    </p>
                </div>
                
                <div class="practice-card">
                    <h4>âœ… Replica Count Patches</h4>
                    <div class="code-block" style="margin-top: 10px;">
patches:
- target:
    kind: Deployment
  patch: |-
    - op: replace
      path: /spec/replicas
      value: <span class="code-highlight">3</span>  <span class="code-comment"># prod: 3, staging: 2, dev: 1</span>
                    </div>
                    <p style="margin-top: 10px; color: #4a5568;">
                        <strong>Why:</strong> Production needs more replicas for HA.
                    </p>
                </div>
                
                <div class="practice-card">
                    <h4>âœ… Resource Limits</h4>
                    <div class="code-block" style="margin-top: 10px;">
patches:
- target:
    kind: Deployment
  patch: |-
    - op: add
      path: /spec/template/spec/containers/0/resources
      value:
        limits:
          memory: <span class="code-highlight">2Gi</span>
          cpu: <span class="code-highlight">1000m</span>
                    </div>
                    <p style="margin-top: 10px; color: #4a5568;">
                        <strong>Why:</strong> Prod has stricter resource limits for stability.
                    </p>
                </div>
                
                <div class="practice-card">
                    <h4>âœ… Environment Variables</h4>
                    <div class="code-block" style="margin-top: 10px;">
patches:
- target:
    kind: Deployment
  patch: |-
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
        name: LOG_LEVEL
        value: <span class="code-highlight">"debug"</span>  <span class="code-comment"># dev: debug, prod: error</span>
                    </div>
                    <p style="margin-top: 10px; color: #4a5568;">
                        <strong>Why:</strong> Different logging verbosity per environment.
                    </p>
                </div>
                
                <div class="practice-card">
                    <h4>âœ… Additional Resources</h4>
                    <div class="code-block" style="margin-top: 10px;">
resources:
- ../base
- <span class="code-highlight">prod-only-monitoring.yaml</span>
- <span class="code-highlight">prod-only-backup.yaml</span>
                    </div>
                    <p style="margin-top: 10px; color: #4a5568;">
                        <strong>Why:</strong> Some resources only make sense in certain environments.
                    </p>
                </div>
                
                <div class="practice-card">
                    <h4>âœ… Namespace Patches</h4>
                    <div class="code-block" style="margin-top: 10px;">
namespace: <span class="code-highlight">build-service-dev</span>

<span class="code-comment"># Or for multi-tenant:</span>
nameSuffix: <span class="code-highlight">-dev</span>
                    </div>
                    <p style="margin-top: 10px; color: #4a5568;">
                        <strong>Why:</strong> Each environment deploys to different namespace.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Anti-patterns -->
        <div class="section">
            <h2 class="section-title">âš ï¸ Common Mistakes & Anti-patterns</h2>
            
            <div class="best-practices-grid">
                <div class="antipattern-card">
                    <h4>âŒ Duplicating Entire Manifests</h4>
                    <div class="code-block" style="margin-top: 10px;">
<span class="code-comment"># DON'T DO THIS:</span>
staging/deployment.yaml  <span class="code-comment">â† Full 200-line file</span>
prod/deployment.yaml     <span class="code-comment">â† Another 200-line file</span>
                    </div>
                    <p style="margin-top: 10px; color: #4a5568;">
                        <strong>Why wrong:</strong> Defeats the purpose of overlays. Use patches instead!
                    </p>
                </div>
                
                <div class="antipattern-card">
                    <h4>âŒ Environment Logic in Base</h4>
                    <div class="code-block" style="margin-top: 10px;">
<span class="code-comment"># DON'T DO THIS in base/:</span>
env:
- name: ENVIRONMENT
  value: "production"  <span class="code-comment">â† Hardcoded!</span>
                    </div>
                    <p style="margin-top: 10px; color: #4a5568;">
                        <strong>Why wrong:</strong> Base should be environment-agnostic. Put env-specific config in overlays!
                    </p>
                </div>
                
                <div class="antipattern-card">
                    <h4>âŒ Not Using Bases Reference</h4>
                    <div class="code-block" style="margin-top: 10px;">
<span class="code-comment"># DON'T DO THIS:</span>
resources:
- ../../base/deployment.yaml
- ../../base/service.yaml
- ../../base/rbac.yaml
                    </div>
                    <p style="margin-top: 10px; color: #4a5568;">
                        <strong>Why wrong:</strong> Use <code>bases: [../base]</code> to reference the entire base directory!
                    </p>
                </div>
                
                <div class="antipattern-card">
                    <h4>âŒ Overly Complex Patches</h4>
                    <div class="code-block" style="margin-top: 10px;">
patches:
- target:
    kind: Deployment
  patch: |-
    <span class="code-comment"># 100 lines of JSON patch...</span>
                    </div>
                    <p style="margin-top: 10px; color: #4a5568;">
                        <strong>Why wrong:</strong> If patches are huge, maybe that config belongs in base with strategic merge!
                    </p>
                </div>
            </div>
        </div>
        
        <!-- How to Work with Overlays -->
        <div class="section">
            <h2 class="section-title">ğŸ› ï¸ How to Work with Overlays in infra-deployments</h2>
            
            <div class="example-box">
                <div class="example-title">ğŸ“ Scenario 1: Adding a New Environment Variable</div>
                <div class="code-block" style="background: white; color: #2d3748; margin-top: 15px;">
<span class="code-comment"># Question: Should I add it to base or overlay?</span>

<span class="code-highlight">âœ… Add to BASE if:</span>
- All environments need it
- It has the same value everywhere
- Example: API endpoint that's the same for all

<span class="code-highlight">âœ… Add to OVERLAY if:</span>
- Value differs per environment
- Only some environments need it
- Example: DEBUG_MODE (true in dev, false in prod)

<span class="code-comment"># HOW to add to base:</span>
1. Edit components/my-service/base/deployment.yaml
2. Add env var to container spec
3. All overlays automatically inherit it!

<span class="code-comment"># HOW to add to overlay:</span>
1. Edit components/my-service/development/kustomization.yaml
2. Add patch with env var
3. Only dev environment gets it!
                </div>
            </div>
            
            <div class="example-box">
                <div class="example-title">ğŸ“ Scenario 2: Changing Container Image</div>
                <div class="code-block" style="background: white; color: #2d3748; margin-top: 15px;">
<span class="code-comment"># This is done by MintMaker (Renovate bot) automatically!</span>

<span class="code-comment"># What MintMaker does:</span>
1. Detects new image in quay.io
2. Opens PR to infra-deployments
3. <span class="code-highlight">Updates image tag in ALL overlays</span> (dev, staging, prod)
4. CI tests the change
5. After merge, ArgoCD deploys

<span class="code-comment"># Files changed by MintMaker PR:</span>
- components/my-service/development/kustomization.yaml
- components/my-service/staging/base/kustomization.yaml
- components/my-service/production/base/kustomization.yaml

<span class="code-comment"># Each gets updated with new image tag:</span>
images:
- name: quay.io/konflux-ci/my-service
  newTag: <span class="code-highlight">abc123def456...</span>  <span class="code-comment">â† NEW SHA!</span>
                </div>
            </div>
            
            <div class="example-box">
                <div class="example-title">ğŸ“ Scenario 3: Adding a New Component</div>
                <div class="code-block" style="background: white; color: #2d3748; margin-top: 15px;">
<span class="code-comment"># Follow the established pattern!</span>

1. Create directory structure:
   components/<span class="code-highlight">my-new-service</span>/
       base/
           kustomization.yaml
           deployment.yaml
           service.yaml
           rbac.yaml
       development/
           kustomization.yaml
       staging/base/
           kustomization.yaml
       production/base/
           kustomization.yaml

2. Write base/ manifests with common config

3. Write overlay kustomization.yaml files:
   - Reference base: <code>bases: [../base]</code>
   - Set image tag
   - Add environment-specific patches

4. Create ArgoCD Application pointing to overlays

5. Test: <code>kubectl kustomize components/my-new-service/development</code>
                </div>
            </div>
        </div>
        
        <!-- Testing Overlays -->
        <div class="section">
            <h2 class="section-title">ğŸ§ª Testing Your Overlay Changes</h2>
            
            <div class="info-box">
                <h3>Before Opening a PR, Always Test Locally!</h3>
            </div>
            
            <div class="code-block">
<span class="code-comment"># 1. Test kustomize build (does it produce valid YAML?)</span>
kubectl kustomize components/build-service/development

<span class="code-comment"># 2. Test kustomize build AND kubectl validation</span>
kubectl kustomize components/build-service/development | kubectl apply --dry-run=client -f -

<span class="code-comment"># 3. Check what changed compared to current deployment</span>
kubectl kustomize components/build-service/development | kubectl diff -f -

<span class="code-comment"># 4. Test all three overlays</span>
kubectl kustomize components/build-service/development
kubectl kustomize components/build-service/staging/base
kubectl kustomize components/build-service/production/base

<span class="code-comment"># 5. Validate with kubeval (if installed)</span>
kubectl kustomize components/build-service/development | kubeval

<span class="code-comment"># Common errors to catch:</span>
<span class="code-highlight">âœ— Error: no matches for kind "Deploymen" (typo!)</span>
<span class="code-highlight">âœ— Error: json: cannot unmarshal number into Go value of type string</span>
<span class="code-highlight">âœ— Error: accumulating resources: accumulation err='...</span>
            </div>
        </div>
        
        <!-- When to Improve Structure -->
        <div class="section">
            <h2 class="section-title">ğŸ¤” When Should You Improve the Overlay Structure?</h2>
            
            <div class="best-practices-grid">
                <div class="practice-card">
                    <h4>âœ… Consider Refactoring When:</h4>
                    <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8; color: #4a5568;">
                        <li>You're copy-pasting the same patch across multiple overlays</li>
                        <li>Base has environment-specific logic (should be in overlays)</li>
                        <li>Overlays duplicate entire manifests instead of patching</li>
                        <li>Multiple components need the same patches (create component base)</li>
                        <li>Patches are becoming unmaintainably complex</li>
                    </ul>
                </div>
                
                <div class="practice-card">
                    <h4>âœ… Signs of Good Structure:</h4>
                    <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8; color: #4a5568;">
                        <li>Base contains only environment-agnostic resources</li>
                        <li>Overlays are small (< 50 lines typically)</li>
                        <li>Clear separation of concerns</li>
                        <li>Easy to understand what differs between environments</li>
                        <li>Changes to common config require editing only base</li>
                    </ul>
                </div>
            </div>
            
            <div class="warning-box" style="margin-top: 30px;">
                <h3>âš ï¸ Warning: Don't Over-Engineer!</h3>
                <p style="margin-top: 10px; line-height: 1.6;">
                    It's tempting to create deeply nested overlay structures or complex patch systems. 
                    <strong>Keep it simple!</strong> The current infra-deployments pattern (base + 3 overlays) 
                    works well for 95% of cases. Only add complexity when you have a clear, repeated need.
                </p>
            </div>
        </div>
        
        <!-- Quick Reference -->
        <div class="section">
            <h2 class="section-title">ğŸ“š Quick Reference Card</h2>
            
            <div class="code-block">
<span class="code-comment">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—</span>
<span class="code-comment">â•‘                 KUSTOMIZE OVERLAYS CHEAT SHEET               â•‘</span>
<span class="code-comment">â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>

<span class="code-highlight">ğŸ“ Structure:</span>
components/my-service/
    base/                     <span class="code-comment">â† Shared by all environments</span>
        kustomization.yaml    <span class="code-comment">â† Lists resources</span>
        *.yaml                <span class="code-comment">â† Actual manifests</span>
    development/              <span class="code-comment">â† Dev-specific</span>
        kustomization.yaml    <span class="code-comment">â† Patches base</span>
    staging/base/             <span class="code-comment">â† Staging-specific</span>
        kustomization.yaml    <span class="code-comment">â† Patches base</span>
    production/base/          <span class="code-comment">â† Prod-specific</span>
        kustomization.yaml    <span class="code-comment">â† Patches base</span>

<span class="code-highlight">ğŸ”§ Common kustomization.yaml Stanzas:</span>

<span class="code-comment"># Reference base:</span>
bases:
- ../base

<span class="code-comment"># Override image tag:</span>
images:
- name: quay.io/konflux-ci/service
  newTag: abc123def456

<span class="code-comment"># Add/modify with patches:</span>
patches:
- target:
    kind: Deployment
    name: my-service
  patch: |-
    - op: replace
      path: /spec/replicas
      value: 3

<span class="code-comment"># Add additional resources:</span>
resources:
- ../base
- extra-configmap.yaml

<span class="code-comment"># Set namespace:</span>
namespace: my-namespace

<span class="code-comment"># Add labels to everything:</span>
commonLabels:
  environment: production

<span class="code-highlight">ğŸ§ª Testing Commands:</span>

kubectl kustomize components/my-service/development
kubectl kustomize components/my-service/development | kubectl apply --dry-run=client -f -
kubectl kustomize components/my-service/development | kubectl diff -f -

<span class="code-highlight">ğŸ“– Learn More:</span>
- Kustomize Docs: https://kustomize.io
- Kubectl Kustomize: https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/
- infra-deployments: https://github.com/redhat-appstudio/infra-deployments
            </div>
        </div>
    </div>
</body>
</html>

