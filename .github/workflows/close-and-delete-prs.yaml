name: Close PRs and delete branches daily

on:
  schedule:
    - cron: '0 8 * * *' 
jobs:
  close_and_delete_prs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up GitHub CLI
      uses: dawidd6/action-install-gh-cli@v1

    - name: Close all open pull requests and delete branches
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh auth login --with-token <<< "${{ secrets.TEST_TOKEN }}"
        PRs=$(gh pr list --state open --json number,headRefName --jq '.[] | "\(.number) \(.headRefName)"')
        while read -r pr branch; do
          gh pr close $pr
          if [[ $branch != "main" && $branch != "master" ]]; then
            git push origin --delete $branch
          fi
        done <<< "$PRs"
